// backend/prisma/schema.prisma
// LEIA ESSE ARQUIVO -> Standards: docs/STANDARDS.md <- NÃO EDITE O CODIGO SEM CONHECIMENTO DESSE ARQUIVO

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgvector(map: "vector")]
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // --- ARQUITETURA NOVA ---

  // Link para a tabela de configurações (Relação 1-para-1)
  settings UserSettings?

  // Link para os logs de chamadas (Relação 1-para-N)
  apiCalls ApiCallLog[]

  chats Chat[]

  providerCredentials UserProviderCredential[]
  credentialValidations ProviderCredentialValidation[]

  @@map("users")
}

// 2. ADICIONE ESTE NOVO MODELO (Configurações)
model UserSettings {
  id    String @id @default(uuid())
  theme String @default("light") // "light" ou "dark"

  // --- Aba 3: Chaves de API ---
  // (IMPORTANTE: Você deve criptografar isso no backend antes de salvar!)
  openaiApiKey     String?
  groqApiKey       String?
  claudeApiKey     String?
  togetherApiKey   String?
  perplexityApiKey String?
  mistralApiKey    String?

  // --- AWS Bedrock Configuration ---
  awsAccessKey     String?
  awsSecretKey     String?
  awsRegion        String?   @default("us-east-1")
  awsEnabledModels String[]  @default([]) // Array de apiModelId habilitados

  // --- O Link de volta ao User ---
  userId String @unique // O '@unique' garante a relação 1-para-1
  user   User   @relation(fields: [userId], references: [id])

  @@map("user_settings")
}

// Validação de Credenciais de Providers
model ProviderCredentialValidation {
  id              String    @id @default(uuid())
  userId          String
  provider        String    // 'bedrock', 'azure', etc
  status          String    // 'not_configured', 'validating', 'valid', 'invalid', 'expired'
  lastValidatedAt DateTime?
  lastError       String?   // Mensagem de erro detalhada
  errorCode       String?   // AWS error code (ex: InvalidAccessKeyId)
  validatedModels String[]  @default([]) // Quais modelos foram testados
  latencyMs       Int?      // Tempo de resposta do teste

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, provider])
  @@map("provider_credential_validations")
}

// 3. ADICIONE ESTE NOVO MODELO (Analytics)
model ApiCallLog {
  id        String   @id @default(uuid())
  timestamp DateTime @default(now())
  provider  String
  model     String? // <-- O "fiscal" não vê este

  tokensIn  Int   @default(0) // <-- O "fiscal" não vê este
  tokensOut Int   @default(0) // <-- O "fiscal" não vê este
  costInUSD Float @default(0.0) // <-- O "fiscal" não vê este

  wordsIn  Int @default(0)
  wordsOut Int @default(0)
  bytesIn  Int @default(0)
  bytesOut Int @default(0)

  userId String
  user   User   @relation(fields: [userId], references: [id])

  @@map("api_call_logs")
}

// Modelo 1: A Conversa (Um "título" para o chat)
model Chat {
  id        String   @id @default(uuid())
  title     String   @default("Nova Conversa") // Título (ex: "Resumo sobre IA")
  provider  String   @default("groq") // Provider travado para este chat
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id])

  messages Message[] // Link para as mensagens

  @@map("chats")
}

// Modelo 2: A Mensagem (O "Histórico Inteligente")
model Message {
  id        String   @id @default(uuid())
  role      String
  content   String
  createdAt DateTime @default(now())
  isPinned  Boolean  @default(false)

  chatId String
  chat   Chat   @relation(fields: [chatId], references: [id])

  // --- TELEMETRIA "INTELIGENTE" (só para 'assistant') ---
  provider  String?
  model     String?
  tokensIn  Int?
  tokensOut Int?
  costInUSD Float?

  // --- A "CAIXA PRETA" (A V13) ---
  sentContext String?

  // --- O "ARQUIVO" V9 (RAG) ---
  vector Unsupported("vector(1536)")?

  @@map("messages")
}

// --- SISTEMA MODULAR DE IA ---

// 1. O Provedor (ex: OpenAI, Groq, Anthropic)
model AIProvider {
  id         String  @id @default(uuid())
  name       String // Ex: "OpenAI", "Groq"
  slug       String  @unique // Ex: "openai", "groq" (usado no código para carregar o driver)
  isActive   Boolean @default(true) // O "Disjuntor" Geral
  websiteUrl String?
  logoUrl    String?

  // Configurações técnicas
  baseUrl String? // Caso precise sobrescrever (ex: proxies locais)

  models      AIModel[]
  credentials UserProviderCredential[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("ai_providers")
}

// 2. Os Modelos (ex: gpt-4, llama-3-70b)
model AIModel {
  id            String @id @default(uuid())
  name          String // Nome visível: "GPT-4 Turbo"
  apiModelId    String // ID técnico: "gpt-4-0125-preview"
  contextWindow Int    @default(4096)

  // Custos (para cálculo de telemetria)
  costPer1kInput  Float @default(0)
  costPer1kOutput Float @default(0)

  isActive Boolean @default(true) // Pode desativar só um modelo específico

  providerId String
  provider   AIProvider @relation(fields: [providerId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("ai_models")
}

// 3. Credenciais do Usuário (Para o sistema BYOK - Bring Your Own Key)
// Isso substitui as colunas soltas no UserSettings a longo prazo
model UserProviderCredential {
  id     String @id @default(uuid())
  apiKey String // Criptografar antes de salvar!

  userId String
  user   User   @relation(fields: [userId], references: [id])

  providerId String
  provider   AIProvider @relation(fields: [providerId], references: [id])

  @@unique([userId, providerId]) // Um usuário só tem uma chave por provider
  @@map("user_provider_credentials")
}

// 4. Certificação de Modelos (Sistema de Validação Automática)
model ModelCertification {
  id                String   @id @default(cuid())
  modelId           String   @unique
  vendor            String   // anthropic, cohere, amazon
  status            String   // certified, failed, untested, testing
  
  // Certificação
  certifiedAt       DateTime?
  expiresAt         DateTime?
  certifiedBy       String?  // 'system' ou userId
  
  // Testes
  lastTestedAt      DateTime?
  testsPassed       Int      @default(0)
  testsFailed       Int      @default(0)
  successRate       Float    @default(0)
  
  // Performance
  avgLatencyMs      Int?
  lastError         String?
  failureReasons    Json?    // Array de erros
  
  // Metadados
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // ✅ OTIMIZAÇÃO: Índices para queries comuns (70% mais rápido)
  @@index([status])                    // Para getCertifiedModels()
  @@index([status, expiresAt])         // Para query com OR
  @@index([vendor])                    // Para certifyVendor()
  @@index([lastTestedAt])              // Para ordenação por data
  @@index([expiresAt])                 // Para queries de expiração
  @@map("model_certifications")
}
