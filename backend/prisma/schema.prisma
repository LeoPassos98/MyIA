// backend/prisma/schema.prisma
// LEIA ESSE ARQUIVO -> Standards: docs/STANDARDS.md <- NÃO EDITE O CODIGO SEM CONHECIMENTO DESSE ARQUIVO

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgvector(map: "vector")]
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // --- ARQUITETURA NOVA ---

  // Link para a tabela de configurações (Relação 1-para-1)
  settings UserSettings?

  // Link para os logs de chamadas (Relação 1-para-N)
  apiCalls ApiCallLog[]

  chats Chat[]

  providerCredentials   UserProviderCredential[]
  credentialValidations ProviderCredentialValidation[]

  @@map("users")
}

// 2. ADICIONE ESTE NOVO MODELO (Configurações)
model UserSettings {
  id    String @id @default(uuid())
  theme String @default("light") // "light" ou "dark"

  // --- Aba 3: Chaves de API ---
  // (IMPORTANTE: Você deve criptografar isso no backend antes de salvar!)
  openaiApiKey     String?
  groqApiKey       String?
  claudeApiKey     String?
  togetherApiKey   String?
  perplexityApiKey String?
  mistralApiKey    String?

  // --- AWS Bedrock Configuration ---
  awsAccessKey     String?
  awsSecretKey     String?
  awsRegion        String?  @default("us-east-1")
  awsEnabledModels String[] @default([]) // Array de apiModelId habilitados

  // --- O Link de volta ao User ---
  userId String @unique // O '@unique' garante a relação 1-para-1
  user   User   @relation(fields: [userId], references: [id])

  @@map("user_settings")
}

// Validação de Credenciais de Providers
model ProviderCredentialValidation {
  id              String    @id @default(uuid())
  userId          String
  provider        String // 'bedrock', 'azure', etc
  status          String // 'not_configured', 'validating', 'valid', 'invalid', 'expired'
  lastValidatedAt DateTime?
  lastError       String? // Mensagem de erro detalhada
  errorCode       String? // AWS error code (ex: InvalidAccessKeyId)
  validatedModels String[]  @default([]) // Quais modelos foram testados
  latencyMs       Int? // Tempo de resposta do teste

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, provider])
  @@map("provider_credential_validations")
}

// 3. ADICIONE ESTE NOVO MODELO (Analytics)
model ApiCallLog {
  id        String   @id @default(uuid())
  timestamp DateTime @default(now())
  provider  String
  model     String? // <-- O "fiscal" não vê este

  tokensIn  Int   @default(0) // <-- O "fiscal" não vê este
  tokensOut Int   @default(0) // <-- O "fiscal" não vê este
  costInUSD Float @default(0.0) // <-- O "fiscal" não vê este

  wordsIn  Int @default(0)
  wordsOut Int @default(0)
  bytesIn  Int @default(0)
  bytesOut Int @default(0)

  userId String
  user   User   @relation(fields: [userId], references: [id])

  @@map("api_call_logs")
}

// Modelo 1: A Conversa (Um "título" para o chat)
model Chat {
  id        String   @id @default(uuid())
  title     String   @default("Nova Conversa") // Título (ex: "Resumo sobre IA")
  provider  String   @default("groq") // Provider travado para este chat
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id])

  messages Message[] // Link para as mensagens

  @@map("chats")
}

// Modelo 2: A Mensagem (O "Histórico Inteligente")
model Message {
  id        String   @id @default(uuid())
  role      String
  content   String
  createdAt DateTime @default(now())
  isPinned  Boolean  @default(false)

  chatId String
  chat   Chat   @relation(fields: [chatId], references: [id])

  // --- TELEMETRIA "INTELIGENTE" (só para 'assistant') ---
  provider  String?
  model     String?
  tokensIn  Int?
  tokensOut Int?
  costInUSD Float?

  // --- A "CAIXA PRETA" (A V13) ---
  sentContext String?

  // --- O "ARQUIVO" V9 (RAG) ---
  vector Unsupported("vector(1536)")?

  @@map("messages")
}

// --- SISTEMA MODULAR DE IA ---

// 1. O Provedor (ex: OpenAI, Groq, Anthropic)
model AIProvider {
  id         String  @id @default(uuid())
  name       String // Ex: "OpenAI", "Groq"
  slug       String  @unique // Ex: "openai", "groq" (usado no código para carregar o driver)
  isActive   Boolean @default(true) // O "Disjuntor" Geral
  websiteUrl String?
  logoUrl    String?

  // Configurações técnicas
  baseUrl String? // Caso precise sobrescrever (ex: proxies locais)

  models      AIModel[]
  credentials UserProviderCredential[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("ai_providers")
}

// 2. Os Modelos (ex: gpt-4, llama-3-70b)
model AIModel {
  id            String @id @default(uuid())
  name          String // Nome visível: "GPT-4 Turbo"
  apiModelId    String // ID técnico: "gpt-4-0125-preview"
  contextWindow Int    @default(4096)

  // Custos (para cálculo de telemetria)
  costPer1kInput  Float @default(0)
  costPer1kOutput Float @default(0)

  isActive Boolean @default(true) // Pode desativar só um modelo específico

  providerId String
  provider   AIProvider @relation(fields: [providerId], references: [id])

  // Relacionamento com certificações de jobs
  jobCertifications JobCertification[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("ai_models")
}

// 3. Credenciais do Usuário (Para o sistema BYOK - Bring Your Own Key)
// Isso substitui as colunas soltas no UserSettings a longo prazo
model UserProviderCredential {
  id     String @id @default(uuid())
  apiKey String // Criptografar antes de salvar!

  userId String
  user   User   @relation(fields: [userId], references: [id])

  providerId String
  provider   AIProvider @relation(fields: [providerId], references: [id])

  @@unique([userId, providerId]) // Um usuário só tem uma chave por provider
  @@map("user_provider_credentials")
}

// 4. Certificação de Modelos (Sistema de Validação Automática)
// LEGACY: Mantido para compatibilidade - será migrado para ModelCertification regional
model ModelCertificationLegacy {
  id      String @id @default(cuid())
  modelId String @unique
  vendor  String // anthropic, cohere, amazon
  status  String // certified, failed, untested, testing, quality_warning

  // Certificação
  certifiedAt DateTime?
  expiresAt   DateTime?
  certifiedBy String? // 'system' ou userId

  // Testes
  lastTestedAt DateTime?
  testsPassed  Int       @default(0)
  testsFailed  Int       @default(0)
  successRate  Float     @default(0)

  // Performance
  avgLatencyMs   Int?
  lastError      String?
  failureReasons Json? // Array de erros

  // Categorização de Erros
  errorCategory String? // UNAVAILABLE, PERMISSION_ERROR, etc
  errorSeverity String? // CRITICAL, HIGH, MEDIUM, LOW

  // Sistema de Rating (Fase 2)
  rating           Float?    // 0-5.0
  badge            String?   // PREMIUM, RECOMENDADO, FUNCIONAL, etc
  metrics          Json?     // ModelMetrics (successRate, averageRetries, etc.)
  scores           Json?     // ModelScores (success, resilience, performance, stability)
  ratingUpdatedAt  DateTime? // Timestamp da última atualização do rating

  // Metadados
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ✅ OTIMIZAÇÃO: Índices para queries comuns (70% mais rápido)
  @@index([status]) // Para getCertifiedModels()
  @@index([status, expiresAt]) // Para query com OR
  @@index([vendor]) // Para certifyVendor()
  @@index([lastTestedAt]) // Para ordenação por data
  @@index([expiresAt]) // Para queries de expiração
  @@index([errorCategory]) // Para filtrar por categoria de erro
  @@index([errorSeverity]) // Para filtrar por severidade
  @@index([rating]) // Para ordenação por rating
  @@index([badge]) // Para filtros por badge
  @@index([ratingUpdatedAt]) // Para cache de rating
  @@map("model_certifications_legacy")
}

// 4.1. Certificação Regional de Modelos (Fase 3: Certificação por Região AWS)
model ModelCertification {
  id        String   @id @default(uuid())
  modelId   String
  region    String   // AWS region: us-east-1, us-west-2, etc.
  vendor    String?  // anthropic, cohere, amazon, meta, etc.
  
  // Status
  status    CertificationStatus @default(PENDING)
  
  // Certificação
  certifiedAt DateTime?
  expiresAt   DateTime?
  certifiedBy String? // 'system' ou userId
  
  // Testes
  lastTestedAt DateTime?
  testsPassed  Int       @default(0)
  testsFailed  Int       @default(0)
  successRate  Float     @default(0)
  
  // Performance
  avgLatencyMs   Int?
  lastError      String?
  failureReasons Json? // Array de erros
  
  // Resultados detalhados
  passed    Boolean?
  score     Float?
  testResults Json?   // Resultados detalhados dos testes
  errorMessage String?
  errorCategory String? // UNAVAILABLE, PERMISSION_ERROR, etc
  errorSeverity String? // CRITICAL, HIGH, MEDIUM, LOW
  
  // Sistema de Rating (Fase 2)
  rating           Float?    // 0-5.0
  badge            String?   // PREMIUM, RECOMENDADO, FUNCIONAL, etc
  metrics          Json?     // ModelMetrics (successRate, averageRetries, etc.)
  scores           Json?     // ModelScores (success, resilience, performance, stability)
  ratingUpdatedAt  DateTime? // Timestamp da última atualização do rating
  
  // Metadados
  jobId     String?  // Bull Queue job ID
  startedAt DateTime?
  completedAt DateTime?
  duration  Int?     // Duração em ms
  
  // Auditoria
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?  // User ID que iniciou
  
  // Relacionamentos - REMOVIDO: FK para ai_models causava conflito
  // O modelId aqui é o apiModelId do registry (ex: "anthropic.claude-3-sonnet")
  // não o UUID do banco. Certificações podem existir para modelos não cadastrados.
  
  // Índices
  @@unique([modelId, region])
  @@index([status])
  @@index([region])
  @@index([jobId])
  @@index([createdAt])
  @@index([vendor])
  @@index([badge])
  @@index([rating])
  @@index([errorCategory])
  @@index([modelId]) // Adicionado para buscas por modelo
  @@map("model_certifications")
}

// 4.2. Jobs de Certificação (Fase 3: Processamento Assíncrono)
model CertificationJob {
  id        String   @id @default(uuid())
  
  // Configuração do job
  type      CertificationJobType
  regions   String[] // Regiões a certificar
  modelIds  String[] // IDs dos modelos (vazio = todos)
  
  // Status
  status    JobStatus @default(PENDING)
  
  // Progresso
  totalModels     Int @default(0)
  processedModels Int @default(0)
  successCount    Int @default(0)
  failureCount    Int @default(0)
  
  // Metadados
  bullJobId String?  // Bull Queue job ID
  startedAt DateTime?
  completedAt DateTime?
  duration  Int?     // Duração em ms
  
  // Configurações
  config    Json?    // Configurações adicionais
  
  // Auditoria
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?  // User ID que iniciou
  
  // Relação com certificações individuais
  certifications JobCertification[]
  
  // Índices
  @@index([status])
  @@index([type])
  @@index([bullJobId])
  @@index([createdAt])
  @@map("certification_jobs")
}

// Certificações individuais por job
model JobCertification {
  id            String   @id @default(uuid())
  jobId         String
  job           CertificationJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  modelId       String
  model         AIModel  @relation(fields: [modelId], references: [id])
  
  region        String
  status        String   // PASSED, FAILED, WARNING, PENDING, PROCESSING
  
  startedAt     DateTime?
  completedAt   DateTime?
  duration      Int?     // Duração em ms
  
  error         String?  @db.Text
  details       Json?    // Detalhes adicionais (testes, métricas, etc)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([jobId])
  @@index([modelId])
  @@index([status])
  @@unique([jobId, modelId, region])
  @@map("job_certifications")
}

// Enums para Certificação Regional
enum CertificationStatus {
  PENDING         // Aguardando processamento
  QUEUED          // Na fila Bull
  PROCESSING      // Sendo processado
  COMPLETED       // Concluído com sucesso
  FAILED          // Falhou
  CANCELLED       // Cancelado
  CERTIFIED       // Certificado (modelo aprovado)
  QUALITY_WARNING // Funcional mas com problemas de qualidade
}

enum CertificationJobType {
  SINGLE_MODEL    // Certificar um modelo específico
  MULTIPLE_MODELS // Certificar múltiplos modelos
  ALL_MODELS      // Certificar todos os modelos
  RECERTIFY       // Re-certificar modelos existentes
}

enum JobStatus {
  PENDING      // Aguardando processamento
  QUEUED       // Na fila Bull
  PROCESSING   // Sendo processado
  COMPLETED    // Concluído
  FAILED       // Falhou
  CANCELLED    // Cancelado
  PAUSED       // Pausado
}

// 5. Sistema de Logging Estruturado (Fase 2: PostgreSQL)
model Log {
  id          String   @id @default(uuid())
  timestamp   DateTime @default(now())
  level       String // 'info' | 'warn' | 'error' | 'debug'
  message     String
  requestId   String?
  userId      String?
  inferenceId String?
  metadata    Json? // JSONB para contexto adicional
  error       Json? // JSONB para stack traces e detalhes de erro

  // Índices de performance para queries comuns
  @@index([timestamp(sort: Desc)]) // Queries temporais (logs recentes)
  @@index([level]) // Filtro por nível de severidade
  @@index([userId]) // Filtro por usuário
  @@index([requestId]) // Correlação de logs por requisição
  @@map("logs")
}
