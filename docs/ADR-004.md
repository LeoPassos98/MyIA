# ğŸ“˜ ADR-004 â€” Auditoria como Objeto Rico e Fonte de Verdade

**Status:** Aceito  
**Data:** 2025-12-22  
**Escopo:** Backend + Frontend  
**VersÃ£o:** V1.4

---

## Contexto

A aplicaÃ§Ã£o MyIA executa inferÃªncias de IA com mÃºltiplos modos:

* AutomÃ¡tico (RAG)
* Manual (injeÃ§Ã£o de contexto)
* SeleÃ§Ã£o explÃ­cita de mensagens
* ParÃ¢metros configurÃ¡veis (modelo, temperatura, janela de memÃ³ria, etc.)

Essas execuÃ§Ãµes **precisam ser rastreÃ¡veis**, **explicÃ¡veis** e **confiÃ¡veis**, tanto para debug tÃ©cnico quanto para auditoria futura (governanÃ§a, custos, compliance).

Tentativas iniciais de auditoria baseada em dados *flat* (tokens, provider, custo soltos) mostraram-se insuficientes para explicar **como** e **por que** uma resposta foi gerada.

---

## DecisÃ£o

Foi decidido que:

1. **Auditoria serÃ¡ um objeto rico e versionado**
2. **Gerada exclusivamente no backend**
3. **Frontend Ã© apenas consumidor**
4. **Debug â‰  Audit**
5. **Audit nÃ£o armazena dados nÃ£o auditÃ¡veis**
6. **O contrato Ã© explÃ­cito e evolutivo (V1.x â†’ V2.x)**

O resultado Ã© o **AuditRecord V1.4**, que representa **uma execuÃ§Ã£o completa de inferÃªncia**, nÃ£o apenas mÃ©tricas.

---

## Estrutura da DecisÃ£o

### âœ” Auditoria Ã© rica (nÃ£o flat)

Inclui:

* contexto da execuÃ§Ã£o
* estratÃ©gia usada
* parÃ¢metros efetivos
* uso de tokens
* custo real
* status de execuÃ§Ã£o

### âœ” Backend Ã© fonte Ãºnica da verdade

* IDs, custos, tokens e status **nÃ£o podem** ser gerados no frontend
* Garante rastreabilidade e consistÃªncia histÃ³rica

### âœ” Debug Ã© separado

* `sentContext`, payload bruto e detalhes tÃ©cnicos **nÃ£o fazem parte do AuditRecord**
* Esses dados pertencem a **debug tÃ©cnico**, nÃ£o auditoria

### âœ” Tokens de histÃ³rico nÃ£o sÃ£o auditÃ¡veis

* Apenas o **resultado final da execuÃ§Ã£o** Ã© auditÃ¡vel
* Tokens internos de RAG/histÃ³rico sÃ£o ruÃ­do

---

## ConsequÃªncias

### Positivas

* Auditoria confiÃ¡vel
* EvoluÃ§Ã£o segura
* Frontend simples
* Observabilidade clara
* Base sÃ³lida para governanÃ§a futura

### Negativas (aceitas)

* Auditoria nÃ£o mostra payload bruto
* Debug exige ferramentas prÃ³prias
* Mais rigor conceitual

---

## Status Final

ğŸ“Œ **DecisÃ£o aceita e implementada no V1.4**  
ğŸ“Œ **MudanÃ§as futuras exigem novo ADR**

---

## ReferÃªncias

* [Contrato AuditRecord V1.4](./audit/README.md)
* [STANDARDS.md](./STANDARDS.md)
* [AuditRecord.ts](../backend/src/audit/domain/AuditRecord.ts)
